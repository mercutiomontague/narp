#!/usr/bin/env ruby
#
require 'narp.rb'
require 'json'

def parse_options
  options = OpenStruct.new
  opt_parser = OptionParser.new do |opts|
    opts.banner = "Usage: narp.rb [options] narp_program_definition"
    mess =  "\nIf the program definition is provided on the command line: \n"
		mess += "1) it must be enclosed in double quotes.\n"
		mess += "2) double quotes and $ within the program definition must be escaped.\n\n"
		mess += "Option:\n"

		opts.separator mess

    opts.on('--file PROGRAM_FILE', 'Read the Narp program definition from PROGRAM_FILE') do |q|
      options.program_file = q
    end

    opts.on('--step-names', 'Return a list of the step-names') do 
      options.step_names_only = true
    end

    opts.on('--input-mappings', 'Return a json array mapping input files to their s3 destination') do
      options.input_mapping = true
    end

    opts.on('--output-mappings', 'Return a json array mapping output files to their s3 destination') do
      options.output_mapping = true
    end

  end
  opt_parser.parse!(ARGV)
  options
end

def read_program_file(opt)
  return nil unless opt.program_file
  File.open(opt.program_file, 'r').readlines.join("\n")
end

opts = parse_options
program = read_program_file(opts) || ARGV.join(' ')
myapp.parse(program)

result =  if opts.step_names_only
            myapp.processing_steps.keys
          elsif opts.input_mapping
            myapps.infiles.s3_mappings
          elsif opts.output_mapping
            myapps.outfiles.s3_mappings
          else
            myapp.processing_steps
          end

puts ::JSON.pretty_generate( result )
